<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Interactive Sites Map — Top50 & 278</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  :root{
    --bg:#e0eaff;
    --card:#ffffff80;
    --accent:#2F80ED;
    --accent-hover:#1C60B3;
    --done:#66ff00;
    --pending-ssv:#ffff66;
    --pending-ft:#ff6666;
    --pending-onair:#6699ff;
    --shadow:0 8px 30px rgba(0,0,0,0.12);
    --radius:12px;
  }

  html, body {
    margin:0;
    height:100%;
    font-family: 'Inter', system-ui, Arial;
    background: linear-gradient(to bottom right, #e0eaff, #ffffff);
    color:#222;
    font-size:14px;
    line-height:1.5;
  }

  .app{
    display:grid;
    grid-template-columns:450px 1fr;
    gap:16px;
    height:100vh;
    padding:16px;
    box-sizing:border-box;
  }

  .panel{
    background:var(--card);
    backdrop-filter: blur(12px);
    border-radius:var(--radius);
    padding:16px;
    box-shadow:var(--shadow);
    display:flex;
    flex-direction:column;
    overflow:auto;
    border:1px solid rgba(255,255,255,0.3);
  }

  #map{
    height:100%;
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    border:2px solid rgba(255,255,255,0.3);
  }

  h2{
    margin-bottom:12px;
    font-weight:700;
    font-size:1.4em;
    color:#1a1a1a;
  }

  label{
    font-weight:600;
    color:#333;
  }

  .controls{
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .row{
    display:flex;
    gap:12px;
    align-items:center;
  }

  select,input[type=text]{
    padding:8px 10px;
    border-radius:var(--radius);
    border:1px solid #ccc;
    transition:0.2s;
  }
  select:focus, input:focus{
    border-color:var(--accent);
    outline:none;
    box-shadow:0 0 8px rgba(47,128,237,0.3);
  }

  .btn{
    padding:10px 16px;
    border-radius:var(--radius);
    border:none;
    font-weight:600;
    cursor:pointer;
    color:#fff;
    background: linear-gradient(135deg,var(--accent),#1e5fc1);
    transition:0.3s;
    box-shadow:0 4px 12px rgba(0,0,0,0.2);
  }
  .btn:hover{
    background:var(--accent-hover);
    transform:translateY(-2px);
    box-shadow:0 6px 16px rgba(0,0,0,0.25);
  }

  .stat{ background:rgba(255,255,255,0.85); flex:1; padding:12px; border-radius:var(--radius); box-shadow:0 4px 12px rgba(0,0,0,0.08); text-align:center; transition:0.2s; } .stat:hover{ box-shadow:0 6px 18px rgba(0,0,0,0.15); transform:translateY(-2px); } .stat .small{ font-weight:500; color:#555; margin-bottom:4px; } .stat div[id]{ font-weight:700; font-size:20px; margin-top:4px; } .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; } .stat-left, .stat-right { /* keep all styles from .stat */ background: var(--card); backdrop-filter: blur(12px); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow); text-align: center; flex: 1; /* take equal space */ margin-right: 8px; /* gap between left and right */ display: flex; flex-direction: column; align-items: center; justify-content: center; border:1px solid rgba(255,255,255,0.3); font-size:14px; /* keep previous font */ } .stat-right { margin-right: 0; /* remove right margin for last box in row */ } .stat-left .small, .stat-right .small { font-weight: 600; /* same as before */ color: #333; /* same as before */ margin-bottom: 4px; }

  .legend {
  display: flex;
  flex-wrap: wrap;       /* allow items to wrap to next row */
  gap: 8px 30px;         /* row gap 8px, column gap 16px */
  font-size: 14px;
  margin-top: 8px;
}

.legend .sw {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 4px;
  border: 2px solid #fff;
  box-shadow: 0 0 4px rgba(0,0,0,0.25);
}

  #details{
    font-size:14px;
    color:#222;
    margin-top:8px;
    padding:8px;
    border-radius:var(--radius);
    background:rgba(255,255,255,0.7);
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
    min-height:64px;
  }

  .search-wrap{
    display:flex;
    gap:8px;
  }

.map-sniper-btn{position:absolute;bottom:20px;right:20px;z-index:9999;width:50px;height:50px;border-radius:50%;background:white;display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px solid #444;box-shadow:0 2px 8px rgba(0,0,0,0.25);}
.map-sniper-btn img{width:28px;height:28px;}
.map-sniper-btn:hover{transform:translateY(-4px);box-shadow:0 6px 18px rgba(0,0,0,0.28);}
hr{border:none;border-top:1px solid #eee;margin:12px 0;}
.color-picker-popup{ position:absolute; z-index:10000; background:#fff; border:1px solid #ccc; padding:8px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.2); display:flex; gap:8px; }
  @media(max-width:950px){
    .app{
      grid-template-columns:1fr;
      grid-template-rows:450px 1fr;
    }
  }
</style>
</head>
<body>
<div class="app">
  <div class="panel">
    <h2>Site Map Dashboard</h2>
    <div class="controls">

      <div class="row">
        <label for="viewSelect">View</label>
        <select id="viewSelect">
          <option value="top50">Top 50</option>
          <option value="batch278">278 sites</option>
          <option value="all">All rows</option>
        </select>
      </div>

      <div class="row">
        <div class="stat">
          <div class="small">On-Air / Total</div>
          <div id="onairTotal">0 / 0</div>
          <div class="small" id="onairPct">0%</div>
        </div>
        <div class="stat">
          <div class="small">FT / Total</div>
          <div id="ftTotal">0 / 0</div>
          <div class="small" id="ftPct">0%</div>
        </div>
        <div class="stat">
          <div class="small">SSV / Total</div>
          <div id="ssvTotal">0 / 0</div>
          <div class="small" id="ssvPct">0%</div>
        </div>
      </div>

      <div class="row legend small">
        <span class="sw" style="background:var(--done)"></span>Done
        <span class="sw" style="background:var(--pending-ssv)"></span>Pending SSV
        <span class="sw" style="background:var(--pending-ft)"></span>Pending FT
        <span class="sw" style="background:var(--pending-onair)"></span>Pending On-Air
      </div>

      <hr/>

      <div class="row search-wrap">
        <input id="searchInput" type="text" placeholder="Search eNodeB ID / Site name"/>
        <button id="searchBtn" class="btn">Find</button>
      </div>

      <div id="details">Hover a marker or search to see details here.</div>

    </div>
  </div>

<div class="panel" style="padding:0;">
    <div id="map">
      <div id="sniperBtn" class="map-sniper-btn" title="Reset view to current filter bounds">
        <img src="https://cdn-icons-png.flaticon.com/512/684/684908.png" alt="sniper">
      </div>
    </div>
  </div>
</div>

<div id="colorPickerPopup" class="color-picker-popup" style="display:none;">
  <label>Pick color: <input type="color" id="pickerInput"/></label>
  <button id="applyColorBtn" class="btn" style="padding:4px 8px;font-size:12px;">Apply</button>
</div>

<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map', { preferCanvas: true }).setView([3.0, 101.5], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
const markersLayer = L.layerGroup().addTo(map);

function dotIcon(color){
  return L.divIcon({
    className:'',
    html:`<div style="width:12px;height:12px;background:${color};border-radius:50%;border:2px solid white;box-shadow:0 0 4px rgba(0,0,0,0.25);"></div>`,
    iconSize:[14,14], iconAnchor:[7,7], popupAnchor:[0,-10]
  });
}

let allRows = [], visibleMarkers = {}, pinnedMarker = null;
let customLegendColors = null;

function normalizeKey(k){ return (k||'').toString().trim().toLowerCase().replace(/\s+/g,'_'); }

function getStatusColor(row){
  const onair=row['on_air_date'], ft=row['ft_date'], ssv=row['ssv_date'];
  const colors = customLegendColors || {
    done: getComputedStyle(document.documentElement).getPropertyValue('--done').trim(),
    pendingSsv: getComputedStyle(document.documentElement).getPropertyValue('--pending-ssv').trim(),
    pendingFt: getComputedStyle(document.documentElement).getPropertyValue('--pending-ft').trim(),
    pendingOnAir: getComputedStyle(document.documentElement).getPropertyValue('--pending-onair').trim()
  };
  if(onair && ft && ssv) return colors.done;
  if(onair && ft && !ssv) return colors.pendingSsv;
  if(onair && !ft) return colors.pendingFt;
  if(!onair) return colors.pendingOnAir;
  return colors.pendingOnAir;
}

function updateLegendUI(newLegend){
  const legendRow = document.querySelector('.legend');
  legendRow.innerHTML='';
  newLegend.forEach(lg=>{
    const span=document.createElement('span');
    span.className='sw';
    span.style.background=lg.color;
    span.title=lg.label;
    span.dataset.statusLabel=lg.label;

    span.addEventListener('click',(e)=>{
      showColorPicker(e.target);
    });

    legendRow.appendChild(span);
    legendRow.appendChild(document.createTextNode(lg.label+' '));
  });
}

function setLegendColors(newColors){
  customLegendColors={
    done:newColors.done,
    pendingSsv:newColors.pendingSsv,
    pendingFt:newColors.pendingFt,
    pendingOnAir:newColors.pendingOnAir
  };
  updateLegendUI([
    {color:newColors.done,label:'Done'},
    {color:newColors.pendingSsv,label:'Pending SSV'},
    {color:newColors.pendingFt,label:'Pending FT'},
    {color:newColors.pendingOnAir,label:'Pending On-Air'}
  ]);
  render();
}
const colorPickerPopup = document.getElementById('colorPickerPopup');
const pickerInput = document.getElementById('pickerInput');
let currentLegendTarget=null;

function showColorPicker(target){
  currentLegendTarget = target;
  const rect = target.getBoundingClientRect();
  colorPickerPopup.style.top = rect.bottom + window.scrollY + 'px';
  colorPickerPopup.style.left = rect.left + window.scrollX + 'px';
  pickerInput.value = rgb2hex(target.style.background);
  colorPickerPopup.style.display='flex';
}

document.getElementById('applyColorBtn').addEventListener('click',()=>{
  if(!currentLegendTarget) return;
  const newColor=pickerInput.value;
  const label=currentLegendTarget.dataset.statusLabel;
  const colorMap={
    'Done':'done',
    'Pending SSV':'pendingSsv',
    'Pending FT':'pendingFt',
    'Pending On-Air':'pendingOnAir'
  };
  const key=colorMap[label];
  customLegendColors[key]=newColor;
  render();
  updateLegendUI([
    {color:customLegendColors.done,label:'Done'},
    {color:customLegendColors.pendingSsv,label:'Pending SSV'},
    {color:customLegendColors.pendingFt,label:'Pending FT'},
    {color:customLegendColors.pendingOnAir,label:'Pending On-Air'}
  ]);
  colorPickerPopup.style.display='none';
});

document.body.addEventListener('click',e=>{
  if(!colorPickerPopup.contains(e.target) && !e.target.classList.contains('sw')){
    colorPickerPopup.style.display='none';
  }
});

function rgb2hex(rgb){
  const result=/rgb\((\d+),\s*(\d+),\s*(\d+)\)/i.exec(rgb);
  return result ? "#" + ((1 << 24) + (parseInt(result[1])<<16) + (parseInt(result[2])<<8) + parseInt(result[3])).toString(16).slice(1) : rgb;
}

function escapeHtml(s){
  if(s===null||s===undefined) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function animateValue(id,start,end,total){
  const obj = document.getElementById(id);
  if(!obj) return;
  let startTimestamp = null;
  const duration = 500;
  const step = (timestamp)=>{
    if(!startTimestamp) startTimestamp = timestamp;
    const progress = Math.min((timestamp-startTimestamp)/duration,1);
    const current = Math.floor(progress*(end-start)+start);
    obj.textContent = total ? `${current} / ${total}` : current;
    if(progress<1) window.requestAnimationFrame(step);
  };
  window.requestAnimationFrame(step);
}

/* -------------------------
   CSV parsing
------------------------- */
function loadCsvText(text){
  const parsed = Papa.parse(text,{header:true,skipEmptyLines:true});
  if(!parsed||!parsed.data){ alert('CSV parse error or no data found.'); return; }

  allRows = parsed.data.map((r,i)=>({
      _rowIndex:i,
      site_code:r['Site Code']||'',
      enodeb_id:r['ENodeB ID']||'',
      enodeb_name:r['eNodeB Name']||'',
      lat:parseFloat(r['Latitude']||NaN),
      lon:parseFloat(r['Longitude']||NaN),
      site_name:r['Site Name']||'',
      swap_batch:r['Swap Batch']||'',
      on_air_date:r['On-Air Date']||'',
      ft_date:r['FT Date']||'',
      ssv_date:r['SSV Date']||'',
      status:r['Status']||''
  }));

  render();
}

/* -------------------------
   Render markers & stats
------------------------- */
function render(){
  markersLayer.clearLayers();
  visibleMarkers={};
  const view=document.getElementById('viewSelect').value;
  let rows=allRows.slice();
  if(view==='top50') rows=allRows.filter(r=>r.swap_batch.toLowerCase().includes('top 50'));
  else if(view==='batch278') rows=allRows.filter(r=>r.swap_batch.toLowerCase().includes('278 sites'));

  let onairDone=0, ftDone=0, ssvDone=0;
  const bounds=[];

  rows.forEach(r=>{
    if(!Number.isFinite(r.lat)||!Number.isFinite(r.lon)) return;
    if(r.on_air_date) onairDone++;
    if(r.ft_date) ftDone++;
    if(r.ssv_date) ssvDone++;

    const color=getStatusColor(r);
    const icon=dotIcon(color);

    const popupHtml=`<div style="min-width:240px">
      <strong>${escapeHtml(r.enodeb_name)}</strong><br/>
      <em>Site Name:</em> ${escapeHtml(r.site_name)}<br/>
      <em>eNodeB ID:</em> ${escapeHtml(r.enodeb_id)}<br/>
      <em>Swap Batch:</em> ${escapeHtml(r.swap_batch)}<br/>
      <em>On-Air Date:</em> ${escapeHtml(r.on_air_date||'—')}<br/>
      <em>FT Date:</em> ${escapeHtml(r.ft_date||'—')}<br/>
      <em>SSV Date:</em> ${escapeHtml(r.ssv_date||'—')}<br/>
      <em>Status:</em> ${escapeHtml(r.status||'—')}</div>`;

    const m=L.marker([r.lat,r.lon],{icon});
    m.bindPopup(popupHtml,{autoClose:false,closeOnClick:false});
    m.on('mouseover',()=>{if(pinnedMarker&&pinnedMarker!==m)pinnedMarker.closePopup(); pinnedMarker=null; m.openPopup(); document.getElementById('details').innerHTML=popupHtml;});
    m.on('mouseout',()=>{if(pinnedMarker!==m)m.closePopup();});
    m.on('click',()=>{if(pinnedMarker&&pinnedMarker!==m)pinnedMarker.closePopup(); pinnedMarker=m; m.openPopup(); document.getElementById('details').innerHTML=popupHtml; map.setView(m.getLatLng(),16);});

    m.addTo(markersLayer);
    const key=(r.enodeb_id||('row'+r._rowIndex)).toString();
    visibleMarkers[key]=m;
    bounds.push([r.lat,r.lon]);
  });

  animateValue('onairTotal',0,onairDone,rows.length);
  animateValue('ftTotal',0,ftDone,rows.length);
  animateValue('ssvTotal',0,ssvDone,rows.length);
  document.getElementById('onairPct').textContent = rows.length ? `${(onairDone/rows.length*100).toFixed(2)}%` : '0.00%';
document.getElementById('ftPct').textContent = rows.length ? `${(ftDone/rows.length*100).toFixed(2)}%` : '0.00%';
document.getElementById('ssvPct').textContent = rows.length ? `${(ssvDone/rows.length*100).toFixed(2)}%` : '0.00%';


  if(bounds.length){
    const b=L.latLngBounds(bounds);
    if(b.isValid()) map.fitBounds(b.pad(0.2));
  }
}

/* -------------------------
   Search / Sniper
------------------------- */
function normForSearch(s){
  if(!s) return '';
  return s.toString().toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]/g,'');
}

function levenshtein(a,b){
  a=a||''; b=b||''; const m=a.length,n=b.length;
  if(m===0) return n;
  if(n===0) return m;
  const dp=Array(n+1).fill(0).map((_,i)=>i);
  for(let i=1;i<=m;i++){
    let prev=dp[0]; dp[0]=i;
    for(let j=1;j<=n;j++){
      const temp=dp[j];
      const cost=a[i-1]===b[j-1]?0:1;
      dp[j]=Math.min(dp[j]+1,dp[j-1]+1,prev+cost);
      prev=temp;
    }
  }
  return dp[n];
}

function fuzzyFindInRows(term,rows){
  const tNorm=normForSearch(term);
  if(!tNorm) return null;
  let exact=rows.find(r=>r.enodeb_id&&r.enodeb_id.toString().trim()===term);
  if(exact) return {row:exact,score:0,type:'exact-id'};
  exact=rows.find(r=>normForSearch(r.site_name)===tNorm||normForSearch(r.enodeb_name)===tNorm);
  if(exact) return {row:exact,score:0,type:'exact-name'};
  const substrMatches=rows.filter(r=>(r.enodeb_id&&r.enodeb_id.toString().toLowerCase().includes(term.toLowerCase()))||
    (r.site_name&&r.site_name.toString().toLowerCase().includes(term.toLowerCase()))||
    (r.enodeb_name&&r.enodeb_name.toString().toLowerCase().includes(term.toLowerCase())));
  if(substrMatches.length===1) return {row:substrMatches[0],score:1,type:'substring'};
  if(substrMatches.length>1) { substrMatches.sort((a,b)=>(a.site_name||a.enodeb_name||'').length-(b.site_name||b.enodeb_name||'').length); return {row:substrMatches[0],score:2,type:'substring-multiple'}; }
  let best=null;
  for(const r of rows){
    const candidates=[normForSearch(r.site_name||''),normForSearch(r.enodeb_name||''),normForSearch(r.enodeb_id||'')];
    for(const c of candidates){
      if(!c) continue;
      const dist=levenshtein(tNorm,c);
      const maxAllowed=Math.max(1,Math.floor(Math.min(3,c.length*0.2)));
      if(dist<=maxAllowed){ if(!best||dist<best.score) best={row:r,score:dist,type:'fuzzy'}; }
    }
  }
  return best;
}

function searchAndZoom(term){
  if(!term||!term.toString().trim()){ alert('Enter a eNodeB ID or Site name'); return; }
  term=term.toString().trim();
  if(visibleMarkers[term]){
    const m=visibleMarkers[term]; map.setView(m.getLatLng(),16); document.getElementById('details').innerHTML=m.getPopup()?m.getPopup().getContent():''; m.openPopup(); pinnedMarker=m; return;
  }
  const exact=allRows.find(r=>r.enodeb_id&&r.enodeb_id.toString().trim()===term);
  if(exact&&Number.isFinite(exact.lat)&&Number.isFinite(exact.lon)){
    map.setView([exact.lat,exact.lon],16);
    const key=(exact.enodeb_id||('row'+exact._rowIndex)).toString();
    if(visibleMarkers[key]){ const m=visibleMarkers[key]; document.getElementById('details').innerHTML=m.getPopup()?m.getPopup().getContent():''; m.openPopup(); pinnedMarker=m; }
    return;
  }
  const result=fuzzyFindInRows(term,allRows);
  if(result&&result.row){
    const found=result.row;
    if(Number.isFinite(found.lat)&&Number.isFinite(found.lon)){
      map.setView([found.lat,found.lon],16);
      const key=(found.enodeb_id||('row'+found._rowIndex)).toString();
      if(visibleMarkers[key]){
        const m=visibleMarkers[key];
        document.getElementById('details').innerHTML=m.getPopup()?m.getPopup().getContent():''; m.openPopup(); pinnedMarker=m;
      } else {
        const popupHtml=`<div style="min-width:220px"><strong>${escapeHtml(found.enodeb_name)}</strong><br/>
          <em>Site Name:</em> ${escapeHtml(found.site_name)}<br/>
          <em>eNodeB ID:</em> ${escapeHtml(found.enodeb_id)}<br/>
          <em>Swap Batch:</em> ${escapeHtml(found.swap_batch)}<br/>
          <em>On-Air Date:</em> ${escapeHtml(found.on_air_date||'—')}<br/>
          <em>FT Date:</em> ${escapeHtml(found.ft_date||'—')}<br/>
          <em>SSV Date:</em> ${escapeHtml(found.ssv_date||'—')}<br/>
          <em>Status:</em> ${escapeHtml(found.status||'—')}</div>`;
        document.getElementById('details').innerHTML=popupHtml; pinnedMarker=null;
      }
      return;
    }
  }
  alert('Site not found (try exact eNodeB ID, or part of the Site Name).');
}

/* -------------------------
   Event listeners
------------------------- */
document.getElementById('viewSelect').addEventListener('change', render);
document.getElementById('searchBtn').addEventListener('click',()=>searchAndZoom(document.getElementById('searchInput').value));
document.getElementById('searchInput').addEventListener('keydown',e=>{if(e.key==='Enter'){ e.preventDefault(); searchAndZoom(e.target.value);}});
document.getElementById('sniperBtn').addEventListener('click',()=>render());

window.addEventListener('load',()=>{ fetchFullList(); setTimeout(()=>map.invalidateSize(),300);setLegendColors({
    done:'#00cc00',
    pendingSsv:'#ffcc00',
    pendingFt:'#ff3300',
    pendingOnAir:'#3399ff'
  }); });

/* -------------------------
   CSV fetch
------------------------- */
let lastCsvText=null;
const REFRESH_INTERVAL_MS=0.5*60*1000;

async function fetchFullList(){
  const SHEET_CSV_URL='https://docs.google.com/spreadsheets/d/1dOMpDElf3ZnGYlP__-gsPkucKy6fh7DwsRXTQ_4HZRw/export?format=csv';
  try{
    const response=await fetch(SHEET_CSV_URL);
    if(!response.ok) throw new Error('Network response not ok');
    const csvText=await response.text();
    if(csvText!==lastCsvText){ lastCsvText=csvText; loadCsvText(csvText); }
  } catch(err){ console.error('Error fetching CSV:',err); }
}
setInterval(fetchFullList,REFRESH_INTERVAL_MS);

</script>
</body>
</html>



